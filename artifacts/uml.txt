// Used on https://dbdiagram.io

// ---------- Tables ----------

Table "states" {
  "id" serial [pk, increment]
  "abbr" varchar(2) [not null, unique]
  "name" varchar(100) [not null, unique]
}

Table "parties" {
  "id" serial [pk, increment]
  "short_name" varchar(120) [not null, unique]
  "long_name" varchar(200) [not null]
  "is_minority" boolean [not null, default: false]
}

Table "elections" {
  "year" integer [pk]
  "date" date [not null, unique]
}

Table "constituencies" {
  "id" serial [pk, increment]
  "number" integer [not null]
  "name" varchar(150) [not null]
  "state_id" integer [not null]

  indexes {
    (number, name) [unique]
  }
}

Table "structural_metrics" {
  "key" varchar(120) [pk]
  "label" varchar(200) [not null]
  "unit" varchar(80)
}

Table "constituency_structural_data" {
  "constituency_election_id" integer [not null]
  "metric_key" varchar(120) [not null]
  "value" double

  indexes {
    (constituency_election_id, metric_key) [pk]
    (constituency_election_id)
  }
}


Table "persons" {
  "id" serial [pk, increment]
  "last_name" text [not null]
  "first_name" text [not null]
  "gender" text
  "birth_year" integer
  "profession" text
}

Table "party_lists" {
  "id" serial [pk, increment]
  "year" integer [not null]
  "state_id" integer [not null]
  "party_id" integer [not null]

  indexes {
    (state_id, party_id, year) [unique]
  }
}

Table "direct_candidacy" {
  "person_id" integer [not null]
  "constituency_election_id" integer [not null]
  "party_id" integer [not null]

  indexes {
    (person_id, constituency_election_id) [pk]
    (constituency_election_id)
  }
}


Table "party_list_candidacy" {
  "person_id" integer [not null]
  "party_list_id" integer [not null]
  "list_position" double

  indexes {
    (person_id, party_list_id) [pk]
  }
}

Table "constituency_elections" {
  "bridge_id" serial [pk, increment]
  "year" integer [not null]
  "constituency_id" integer [not null]
  "eligible_voters" double

  indexes {
    (constituency_id, year) [unique]
  }
}

Table "first_votes" {
  "id" serial [pk, increment]
  "constituency_election_id" integer [not null]
  "direct_person_id" integer [not null]
  "is_valid" boolean [not null, default: true]
  "created_at" date [default: `now()`]

  indexes {
    (constituency_election_id)
  }
}

Table "second_votes" {
  "id" serial [pk, increment]
  "party_list_id" integer [not null]
  "constituency_election_id" integer [not null]
  "is_valid" boolean [not null, default: true]
  "created_at" date [default: `now()`]

  indexes {
    (constituency_election_id)
  }
}

Table "voting_codes" {
  "code" varchar(64) [pk]
  "is_used" boolean [not null, default: false]
  "constituency_election_id" integer [not null]
}

// ---------- Materialized Views (represented as Tables) ----------

Table "mv_00_direct_candidacy_votes" {
  "person_id" integer
  "constituency_election_id" integer
  "year" integer
  "constituency_id" integer
  "party_id" integer
  "first_votes" bigint
  Note: "Materialized View"
}

Table "mv_01_constituency_party_votes" {
  "constituency_election_id" integer
  "constituency_id" integer
  "year" integer
  "party_id" integer
  "vote_type" integer
  "votes" bigint
  Note: "Materialized View"
}

Table "mv_02_party_list_votes" {
  "party_list_id" integer
  "party_id" integer
  "state_id" integer
  "year" integer
  "second_votes" bigint
  Note: "Materialized View"
}

Table "mv_03_constituency_elections" {
  "constituency_election_id" integer
  "constituency_id" integer
  "year" integer
  "valid_first" bigint
  "valid_second" bigint
  "invalid_first" bigint
  "invalid_second" bigint
  Note: "Materialized View"
}

Table "seat_allocation_cache" {
  "id" integer
  "year" integer
  "person_id" integer
  "party_id" integer
  "state_id" integer
  "seat_type" text
  "constituency_name" text
  "list_position" double
  "percent_first_votes" double
  "created_at" date
  Note: "Materialized View"
}

// ---------- Relationships ----------

Ref "fk_constituencies_state":"states"."id" < "constituencies"."state_id"

Ref "fk_struct_data_bridge":"constituency_elections"."bridge_id" < "constituency_structural_data"."constituency_election_id"
Ref "fk_struct_data_metric":"structural_metrics"."key" < "constituency_structural_data"."metric_key"

Ref "fk_party_lists_year":"elections"."year" < "party_lists"."year"
Ref "fk_party_lists_state":"states"."id" < "party_lists"."state_id"
Ref "fk_party_lists_party":"parties"."id" < "party_lists"."party_id"

Ref "fk_direct_candidacy_person":"persons"."id" < "direct_candidacy"."person_id"
Ref "fk_direct_candidacy_party":"parties"."id" < "direct_candidacy"."party_id"
Ref "fk_direct_candidacy_bridge":"constituency_elections"."bridge_id" < "direct_candidacy"."constituency_election_id"

Ref "fk_party_list_candidacy_person":"persons"."id" < "party_list_candidacy"."person_id"
Ref "fk_party_list_candidacy_list":"party_lists"."id" < "party_list_candidacy"."party_list_id"

Ref "fk_constituency_elections_year":"elections"."year" < "constituency_elections"."year"
Ref "fk_constituency_elections_constituency":"constituencies"."id" < "constituency_elections"."constituency_id"

// Composite Foreign Key for First Votes
Ref "fk_first_votes_direct_candidacy": "direct_candidacy".("person_id", "constituency_election_id") < "first_votes".("direct_person_id", "constituency_election_id")
Ref "fk_second_votes_party_list":"party_lists"."id" < "second_votes"."party_list_id"
Ref "fk_second_votes_bridge":"constituency_elections"."bridge_id" < "second_votes"."constituency_election_id"

Ref "fk_voting_codes_election":"constituency_elections"."bridge_id" < "voting_codes"."constituency_election_id"


  // ===========================================
// MATERIALIZED VIEW RELATIONSHIPS (Logical)
// ===========================================

// // MV 00: Direct Candidacy Votes
// Ref: "mv_00_direct_candidacy_votes"."person_id" > "persons"."id"
// Ref: "mv_00_direct_candidacy_votes"."constituency_id" > "constituencies"."id"
// Ref: "mv_00_direct_candidacy_votes"."party_id" > "parties"."id"
// Ref: "mv_00_direct_candidacy_votes"."year" > "elections"."year"

// // MV 01: Constituency Party Votes
// Ref: "mv_01_constituency_party_votes"."constituency_id" > "constituencies"."id"
// Ref: "mv_01_constituency_party_votes"."party_id" > "parties"."id"
// Ref: "mv_01_constituency_party_votes"."year" > "elections"."year"

// // MV 02: Party List Votes
// Ref: "mv_02_party_list_votes"."party_list_id" > "party_lists"."id"
// Ref: "mv_02_party_list_votes"."party_id" > "parties"."id"
// Ref: "mv_02_party_list_votes"."state_id" > "states"."id"
// Ref: "mv_02_party_list_votes"."year" > "elections"."year"

// // MV 03: Constituency Elections (Aggregates)
// Ref: "mv_03_constituency_elections"."constituency_id" > "constituencies"."id"
// Ref: "mv_03_constituency_elections"."year" > "elections"."year"

// // Seat Allocation Cache (Final Calculation)
// Ref: "seat_allocation_cache"."person_id" > "persons"."id"
// Ref: "seat_allocation_cache"."party_id" > "parties"."id"
// Ref: "seat_allocation_cache"."state_id" > "states"."id"
// Ref: "seat_allocation_cache"."year" > "elections"."year"

// Ref: "mv_00_direct_candidacy_votes"."constituency_election_id" > "constituency_elections"."bridge_id"
// Ref: "mv_01_constituency_party_votes"."constituency_election_id" > "constituency_elections"."bridge_id"
// Ref: "mv_03_constituency_elections"."constituency_election_id" > "constituency_elections"."bridge_id"
